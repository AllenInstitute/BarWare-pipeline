## BarWare-pipeline


## Installing and running the pipeline

### Repository retrieval and installation

```
git clone https://github.com/AllenInstitute/BarWare-pipeline
cd BarWare-pipeline
git submodule update --init
R -e 'install.packages("BarMixer", type = "source", repos = NULL)'
```

### Running the pipeline

#### Stage 0: Run cellranger count

The BarWare pipeline is currently configured to demultiplex 10x Genomics 3' scRNA-seq data. Before analysis with BarCounter and BarMixer, we recommend that you run cellranger count to obtain the necessary scRNA-seq inputs for use with this pipeline.

If you are using a different analysis pipeline or method and would like to utilize BarWare, please let us know in the Issues page.

#### Stage 1: Counting HTOs with BarCounter

**samplesheet.csv**  
The samplesheet.csv file specifies which samples are associated with which barcodes. This .csv should have the following columns:  
- sample_id: The name of each multiplexed sample
- pool_id: An identifier for the pool of samples to demultiplex
- hash_name: The name of the HTOs used for hashing
- hash_tag: The sequence of the HTO barcodes used for hashing

**example samplesheet**
```
sample_id,pool_id,hash_name,hash_tag
2735BW-MEM-1,X017-P1,HT1,GTCAACTCTTTAGCG
2735BW-MEM-2,X017-P1,HT2,TGATGGCCTATTGGG
2735BW-NIV-1,X017-P1,HT3,TTCCGCCTCTCTTTG
2735BW-NIV-2,X017-P1,HT4,AGTAAGTTCAGCGTA
2735BW-NON-1,X017-P1,HT5,AAGTATCGTTTCGCA
2735BW-NON-2,X017-P1,HT6,GGTTGCCAGATGTCA
```

#### Stage 2: Demultiplexing and QC with BarMixer

In addition to the samplesheet.csv file defined above, you'll need an additional file to perform demultiplexing using the scripts in the `BarMixer` package:

**WellSheet.csv**
The WellSheet.csv file specifies which wells will be demultiplexed. This .csv should have the following columns:
- WellID: An identifier for each well
- BarCounts: The full path to the Tag_Counts.csv output generated by BarCounter for each well
- CellRangerOuts: The full path to the cellranger count outs/ directory for each well

**Example WellSheet**
```
well_id,bar_counts,cellranger_outs
X017-P1C1W1,/mnt/barware-manuscript/code-testing/X017-P1C1W1/hto_counts/Pool-16-HTO_Tag_Counts.csv,/mnt/barware-manuscript/code-testing/X017-P1C1W1/outs/
X017-P1C1W2,/mnt/barware-manuscript/code-testing/X017-P1C1W2/hto_counts/Pool-24-HTO_Tag_Counts.csv,/mnt/barware-manuscript/code-testing/X017-P1C1W2/outs/
X017-P1C1W3,/mnt/barware-manuscript/code-testing/X017-P1C1W3/hto_counts/Pool-32-HTO_Tag_Counts.csv,/mnt/barware-manuscript/code-testing/X017-P1C1W3/outs/
```

Once these inputs are available, the BarMixer pipeline can be run using the `run_BarMixer.sh` shell script. This script has 3 parameters:
- `-s`: the path to the samplesheet.csv file
- `-w`: the path to the wellsheet.csv file
- `-o`: A directory to use for outputs

```
bash BarWare-pipeline/02_run_BarMixer.sh \
  -s X017_samplesheet.csv
  -w X017_WellSheet.csv \
  -o X017_demultiplex_results
```

## Using a docker image

**Image retrieval**  
A pre-built docker image containing the BarWare pipeline can be downloaded from dockerhub using:
```
docker pull hypercompetent/barware:latest
```

**Image building**  
If you would like to re-build the Docker image, the Dockerfile is provided in the BarWare-pipeline repository:
```
cd BarWare-pipeline
docker build ./ -t barware:v1.0
```

