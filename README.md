## BarcodeTender-pipeline


## Installing and running the pipeline

### Repository retrieval and installation

```
git clone https://github.com/AllenInstitute/BarcodeTender-pipeline
cd BarcodeTender-pipeline
git submodule update --init
R -e 'install.packages("BarMixer", source = TRUE, repos = NULL)'
```

### Running the pipeline

#### Stage 0: Run cellranger count

The BarcodeTender pipeline is currently configured to demultiplex 10x Genomics 3' scRNA-seq data. Before analysis with BarCounter and BarMixer, we recommend that you run cellranger count to obtain the necessary scRNA-seq inputs for use with this pipeline.

If you are using a different analysis pipeline or method and would like to utilize BarcodeTender, please let us know in the Issues page.

#### Stage 1: Counting HTOs with BarCounter

**SampleSheet.csv**  
The SampleSheet.csv file specifies which samples are associated with which barcodes. This .csv should have the following columns:  
- SampleID: The name of each multiplexed sample
- PoolID: An identifier for the pool of samples to demultiplex
- HashName: The name of the HTOs used for hashing
- HashTag: The sequence of the HTO barcodes used for hashing

**example SampleSheet**
```
SampleID,PoolID,HashName,HashTag
2735BW-MEM-1,X017-P1,HT1,GTCAACTCTTTAGCG
2735BW-MEM-2,X017-P1,HT2,TGATGGCCTATTGGG
2735BW-NIV-1,X017-P1,HT3,TTCCGCCTCTCTTTG
2735BW-NIV-2,X017-P1,HT4,AGTAAGTTCAGCGTA
2735BW-NON-1,X017-P1,HT5,AAGTATCGTTTCGCA
2735BW-NON-2,X017-P1,HT6,GGTTGCCAGATGTCA
```

#### Stage 2: Demultiplexing and QC with BarMixer

In addition to the SampleSheet.csv file defined above, you'll need an additional file to perform demultiplexing using the scripts in the `BarMixer` package:

**WellSheet.csv**
The WellSheet.csv file specifies which wells will be demultiplexed. This .csv should have the following columns:
- WellID: An identifier for each well
- BarCounts: The full path to the Tag_Counts.csv output generated by BarCounter for each well
- CellRangerOuts: The full path to the cellranger count outs/ directory for each well

**Example WellSheet**
```
WellID,BarCounts,CellRangerOuts
X017-P1C1W1,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W1/hto_counts/Pool-16-HTO_Tag_Counts.csv,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W1/outs/
X017-P1C1W2,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W2/hto_counts/Pool-24-HTO_Tag_Counts.csv,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W2/outs/
X017-P1C1W3,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W3/hto_counts/Pool-32-HTO_Tag_Counts.csv,/mnt/barcode-tender-manuscript/code-testing/X017-P1C1W3/outs/
```

Once these inputs are available, the BarMixer pipeline can be run using the `run_BarMixer.sh` shell script. This script has 3 parameters:
- `-s`: the path to the SampleSheet.csv file
- `-w`: the path to the WellSheet.csv file
- `-o`: A directory to use for outputs

```
bash BarcodeTender-pipeline/run_BarMixer.sh \
  -s X017_SampleSheet.csv
  -w X017_WellSheet.csv \
  -o X017_demultiplex_results
```

## Using a docker image

**Image retrieval**  
A pre-built docker image containing the BarcodeTender pipeline can be downloaded from dockerhub using:
```
docker pull hypercompetent/barcodetender:latest
```

**Image building**  
If you would like to re-build the image, the Dockerfile is provided in the BarcodeTender-pipeline repository:
```
cd BarcodeTender-pipeline
docker build ./ -t barcodetender:v1.0
```

